kernel.renderer.registrar_pagelet("renglones",function(L){var A="#"+L.id;var b,t;var s="icon-circle-arrow-down";var o="icon-circle-arrow-up";var F="On";function k(R){if(R.hasClass("js-renglon-regular")){return"regular"}else{return"promocion"}}function u(S){var R=k(S);var T=L.id_escalas[R];return guarani.escalas().recuperar(T)}function G(S){var R=S.split("/");if(R.length!=3){return false}return new Date(R[2],R[1]-1,R[0])}function i(R){return $.trim(R.find("[data-tipo=fecha]").val())}function y(S){var R=S.find("[data-tipo=nota]");if(R.length==0){return false}return $.trim(R.val())}function P(R){return $.trim(R.find("[data-tipo=nota]").data("valor-anterior"))}function r(S,R){return S.find("[data-tipo=nota]").data("valor-anterior",R)}function j(R){return $.trim(R.find(".resultado").val())}function a(R){return $.trim(R.find(".condicion").val())}function z(R){return R.find(".observacion").val()}function f(T){var S=y(T);if(S==""){return""}var R=u(T).get_resultado(S);$.each(_condiciones,function(){if(this.resultado==R){condicion=this;return false}})}function d(S){var R=y(S);if(R==""){return""}return u(S).get_resultado(R)}function h(W,U){var S=u(W);if(S.get_tipo()=="continua"){var V=y(W);if(!U){return}var T=U.keyCode||U.which;T=String.fromCharCode(T);if(!/[0-9]|\.|,/.test(T)&&U.type!=="focusout"){return}var R=S.formatear(V);W.find("[data-tipo=nota]").val(R);r(W,R)}}function e(S){var R=d(S);S.find(".resultado").val(R)}function n(T){var S=j(T);var R=a(T);if(S==""){$.each(_condiciones,function(){if(this.cond==R){res=this.resultado;T.find(".resultado").val(res)}})}else{$.each(_condiciones,function(){if(this.resultado!==S&&this.cond==R){res=this.resultado;T.find(".resultado").val(res);T.find(".nota_cursada").val("")}})}}function B(T){var R=j(T);var S=false;$.each(_condiciones,function(){if(this.resultado==R&&this.preset=="S"){S=this;return false}});if(S===false){console.log("error de matcheo de resultado de condiciï¿½n con resultado de nota")}T.find(".condicion").val(S.cond)}function Q(R){return R.next(".js-renglon-promocion").find("td:eq(1)").is(":visible")}function K(T){if(L.cur_asentar_notas_actas_promocion==L.ingreso_notas_sin_notas){return false}var S=k(T);if(S!="regular"){return false}var X=$(T).data("renglon");var Y=T.next(".js-renglon-promocion[data-renglon='"+X+"']");if(Y.length==0){return false}var W=Q(T);var R=y(T);var U=y(Y);if((!W&&R!="")||(W&&R!=""&&U=="")){var Z=Y.find("[data-tipo=nota]");var V=true;if(Z.is("select")){V=Z.find("option[value='"+R+"']").length>0}Z.val(R);if(m(Y)&&V){e(Y);$(A).plugin_renglones("remove_alerta",Y.find("[data-tipo=nota]"))}else{$(A).plugin_renglones("set_alerta",Y.find("[data-tipo=nota]"),L.mensajes.nota_incompatible);Y.find("[data-tipo=nota]").val("").focus();Y.find("[data-tipo=resultado]").val("");T.find("td.col-nro-acta").prop("rowspan",1).nextAll("td").prop("rowspan",1);T.find("td .js-toggle-acta-promocion i").removeClass(s).addClass(o);Y.find("td").show()}}if((!W)||(W&&i(Y)=="")){Y.find("[data-tipo=fecha]").val(i(T))}N(Y,"fecha");N(Y,"nota");N(Y,"resultado");N(Y,"observacion")}function v(T){var R=$(T).next("tr.js-renglon-promocion");var S=z(R);if(S===""){$(R).find(".observacion").val(z(T)).keyup()}}function m(S){var R=y(S);if(R===""){return true}else{return u(S).validar(R)}}function g(U){var R=j(U);var S=a(U);if(R===""||S===""){return true}else{var T=false;$.each(_condiciones,function(){if(this.resultado==R&&this.cond==S){T=true;return true}});return T}}function N(V,T){var S="[data-tipo="+T+"]";if(!V.find(S).length){return false}var R=V.find(S).val();var U=V.find(S).data("valorOriginal");V.find(S).toggleClass("js-modificado",R!=U);sessionStorage.hay_cambios=$(".js-modificado").length>0;if(sessionStorage.hay_cambios=="true"){$("#js-btn-guardar").prop("disabled",false)}else{$("#js-btn-guardar").prop("disabled",true)}}function x(S){var R=G(S.find(".fecha").val());if(S.find(".fecha").val()!=""&&(R===false||R.getTime()<b.getTime()||t.getTime()<R.getTime())){$(A).plugin_renglones("set_error",S.find(".fecha"),L.mensajes.fecha_invalida)}else{if(F=="On"){K(S)}D();$(A).plugin_renglones("remove_error",S.find(".fecha"))}N(S,"fecha")}function q(T,R,S){if(!m(T)){$(A).plugin_renglones("remove_alerta",T.find("[data-tipo=nota]"));$(A).plugin_renglones("set_error",T.find("[data-tipo=nota]"),L.mensajes.nota_invalida)}else{if(y(T)!=""){h(T,S);e(T);B(T);n(T);if(F=="On"){K(T)}$(A).plugin_renglones("remove_alerta",T.find("[data-tipo=nota]"))}else{T.find(".resultado").val("");T.find(".condicion").val("")}D();$(A).plugin_renglones("remove_error",T.find("[data-tipo=nota]"))}N(T,"nota");N(T,"resultado");N(T,"cond_regularidad")}function M(V){var T=$(V).hasClass("js-renglon-regular");var R=$(V).hasClass("js-renglon-promocion");var U=j(V);var S=d(V);if(U!==S){V.find("[data-tipo=nota]").val("")}if(U!=""){if(T){B(V);I(V);if(F=="On"){K(V)}}}D();if(T){J(V)}else{if(R){p(V)}}N(V,"nota");N(V,"resultado");N(V,"cond_regularidad")}function J(T){var R=j(T);var S=y(T);$(A).plugin_renglones("remove_error",T.find(".nota_cursada"));switch(R){case"":T.find(".nota_cursada").val("");T.find(".condicion").val("");break;case L.resultado_nota_aprobado:switch(L.cur_asentar_notas_actas_regulares){case L.ingreso_notas_no_obligatorio:H(T);break;case L.ingreso_notas_obligatorio:if(!S){$(A).plugin_renglones("set_error",T.find(".nota_cursada"),L.mensajes.nota_obligatoria)}H(T);break;case L.ingreso_notas_sin_notas:T.find(".nota_cursada").val("");break}break;case L.resultado_nota_desaprobado:switch(L.cur_asentar_notas_actas_regulares){case L.ingreso_notas_no_obligatorio:H(T);break;case L.ingreso_notas_obligatorio:if(!S){$(A).plugin_renglones("set_error",T.find(".nota_cursada"),L.mensajes.nota_obligatoria)}H(T);break;case L.ingreso_notas_sin_notas:T.find(".nota_cursada").val("");break}break;case L.resultado_nota_ausente:T.find(".nota_cursada").val("");break}}function H(U){var T=y(U);var S=j(U);var R=d(U);if(!T){return false}if((!m(U))||(S!=R)){$(A).plugin_renglones("set_error",U.find(".nota_cursada"),L.mensajes.nota_invalida)}}function p(T){var R=j(T);var S=y(T);$(A).plugin_renglones("remove_error",T.find(".nota_promocion"));switch(R){case"":T.find(".nota_promocion").val("");break;case L.resultado_nota_aprobado:switch(L.cur_asentar_notas_actas_promocion){case L.ingreso_notas_no_obligatorio:E(T);break;case L.ingreso_notas_obligatorio:if(!S){$(A).plugin_renglones("set_error",T.find(".nota_promocion"),L.mensajes.nota_obligatoria)}E(T);break;case L.ingreso_notas_sin_notas:T.find(".nota_promocion").val("");break}break;case L.resultado_nota_desaprobado:switch(L.cur_asentar_notas_actas_promocion){case L.ingreso_notas_no_obligatorio:E(T);break;case L.ingreso_notas_obligatorio:if(!S){$(A).plugin_renglones("set_error",T.find(".nota_promocion"),L.mensajes.nota_obligatoria)}E(T);break;case L.ingreso_notas_sin_notas:T.find(".nota_promocion").val("");break}break;case L.resultado_nota_ausente:T.find(".nota_promocion").val("");break}}function E(U){var T=y(U);var S=j(U);var R=d(U);if(!T){return false}if((R==L.resultado_nota_aprobado)&&($.inArray(S,[L.resultado_nota_aprobado,L.resultado_nota_desaprobado])==-1)){$(A).plugin_renglones("set_error",U.find("[data-tipo=nota]"),L.mensajes.nota_invalida)}else{if((R==L.resultado_nota_desaprobado)&&(S!=L.resultado_nota_desaprobado)){$(A).plugin_renglones("set_error",U.find("[data-tipo=nota]"),L.mensajes.nota_invalida)}}}function I(R){n(R);if(!g(R)){$(A).plugin_renglones("set_error",R.find(".condicion"),L.mensajes.condicion_invalida)}else{$(A).plugin_renglones("remove_error",R.find(".condicion"))}N(R,"nota");N(R,"resultado");N(R,"cond_regularidad")}function D(){var R=false;$(".js-toggle-acta-promocion").each(function(){var V=$(this).parents("tr");var aa=V.next(".js-renglon-promocion");var Y=i(V);var Z=i(aa);var ab=y(V);var ac=y(aa);var S=j(V);var U=j(aa);var T=z(V);var W=z(aa);var X=((Y===Z)&&(ab===ac)&&(S===U)&&(T===W));if(!X){if(!aa.find("td").is(":visible")){$(this).trigger("click")}$(this).addClass("disabled")}else{$(this).removeClass("disabled");R=true}});if(R){$("#js-toggle-acta-promocion").removeClass("disabled")}else{$("#js-toggle-acta-promocion").addClass("disabled")}}var O=false;function w(){D();$("#js-toggle-acta-promocion").on("click",function(){if($(this).hasClass("disabled")){return false}$(this).toggleClass("open");var T=$(this).hasClass("open");O=T?"open":"close";$(A).find(".js-toggle-acta-promocion").trigger("click");O=false;var S="icon-circle-arrow-down";var R="icon-circle-arrow-up";$(this).find("i").toggleClass(R,T);$(this).find("i").toggleClass(S,!T);$(this).attr("data-original-title",T?L.mensajes.esconder_actas_promocion:L.mensajes.mostrar_actas_promocion).tooltip("fixTitle").tooltip("show")});$("#js-toggle-acta-promocion").tooltip();$(A+" .js-toggle-acta-promocion").on("click",function(){if($(this).hasClass("disabled")){return false}var T=$(this).closest("tr");var S=T.next("tr");var R=!S.find("td:first").is(":visible");if(O!==false){R=O==="open"}if(R){T.find("td.col-nro-acta").prop("rowspan",1).nextAll("td").prop("rowspan",1);T.find("td .js-toggle-acta-promocion i").removeClass(s).addClass(o);S.find("td").show()}else{S.find("td").hide();T.find("td .js-toggle-acta-promocion i").removeClass(o).addClass(s);T.find("td.col-nro-acta").prop("rowspan",2).nextAll("td").prop("rowspan",2)}return false})}function l(){if(L.tiene_dos_instancias&&!L.tiene_instancias_con_misma_escala){var R=readCookie("autocompletar_promocion");if(R){F=R}else{createCookie("autocompletar_promocion",F)}if(F=="On"){$(".js-autocompletar-promocion.on").addClass("active");$(".js-autocompletar-promocion.off").removeClass("active")}else{$(".js-autocompletar-promocion.on").removeClass("active");$(".js-autocompletar-promocion.off").addClass("active")}$(".js-autocompletar-promocion").on("click",function(){F=$(this).data("value");createCookie("autocompletar_promocion",F)})}}function C(){if(L.cur_asentar_notas_actas_regulares==L.ingreso_notas_sin_notas){$(".nota_cursada").prop("disabled",true)}if(L.cur_asentar_notas_actas_promocion==L.ingreso_notas_sin_notas){$(".nota_promocion").prop("disabled",true)}}function c(R){var S=R.find(".observacion").val();if(S.length>100){$(A).plugin_renglones("set_error",R.find(".observacion"),L.mensajes.observacion_invalida)}else{D();$(A).plugin_renglones("remove_error",R.find(".observacion"))}N(R,"observacion")}$(A).on("change","tr.js-renglon-regular input.observacion",function(){if(F=="On"){var R=$(this).parents("tr.js-renglon-regular");v(R)}});return{onload:function(){b=G(L.fecha_inicio);t=G(L.fecha_fin);$(A).plugin_renglones({validadores:[{tipo:["fecha"],validar:x},{tipo:["nota"],validar:q},{tipo:["resultado"],validar:M},{tipo:["cond_regularidad"],validar:I},{tipo:["observacion"],validar:c}],highlight_renglon:L.highlight_renglon,datepicker_min_date:b,datepicker_max_date:t,mostrar_prompt_perdera_cambios:true,msg_prompt_perdera_cambios:L.mensajes.msg_prompt_perdera_cambios,msg_ok_prompt_perdera_cambios:L.mensajes.aceptar,msg_cancel_prompt_perdera_cambios:L.mensajes.cancelar,guardar_cambio_pagina:false,success:function(){w();C();sessionStorage.hay_cambios=false;kernel.ui.show_mensaje(L.mensajes.guardado_exitoso,{until_interaction:true})},error:function(){C();kernel.ui.show_mensaje(L.mensajes.guardado_error,{tipo:"alert-error"})},autocomplete:{url:L.url_autocomplete,mensaje_vacio:L.mensajes.no_se_encontraron_alumnos,min_letras_busqueda:3}});w();l();if($("#js-toggle-acta-promocion").length){$("#js-toggle-acta-promocion").trigger("click").trigger("blur")}$(A).on("keypress","input.nota_cursada, input.nota_promocion",function(R){if(R.which==13){$(this).trigger("blur");return false}});$("#notas_cursada_filtrar_acta").on("change",function(){var S=$(this).val();var R=".js-"+S;if(S=="todas-todas"){$(".js-renglon-regular").show();$(".js-renglon-promocion").show()}else{$(".js-renglon-regular").hide();$(".js-renglon-promocion").hide();$(R).show()}});C()}}});