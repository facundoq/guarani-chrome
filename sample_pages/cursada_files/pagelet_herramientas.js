kernel.renderer.registrar_pagelet("herramientas",function(e){var c="#"+e.id;var b,g;function i(){return guarani.escalas().recuperar(e.id_escala_regularidad)}function d(){return guarani.escalas().recuperar(e.id_escala_promocion)}function a(n){var m=n.split("/");return new Date(m[2],m[1]-1,m[0])}function h(){var m=$("#preset_campo").val();var n=$.trim($("#preset_form").find("#js-valor-"+m).val());if(n===""){$("#btnCompletar").prop("disabled",true)}else{$("#btnCompletar").prop("disabled",false)}}function k(){$(window).on("beforeunload",function(){if(sessionStorage.hay_cambios=="true"){return"¿Está usted seguro de que desea salir de esta página?"}})}function j(){$("a").addClass("no-ajax")}function f(m){$("#preset_form").find(".preset_valor").prop("disabled",true).hide();$("#preset_form").find("#js-valor-"+m).prop("disabled",false).show();$("#preset_form").find("#js-label-preset-valor").attr("for","js-valor-"+m)}function l(){var m=$("#preset_campo").val();f(m)}return{onload:function(){if(e.mensajes.exito_autocompletar){kernel.ui.show_mensaje(e.mensajes.exito_autocompletar,{tipo:"alert-success"})}if(e.mensajes.error_autocompletar){kernel.ui.show_mensaje(e.mensajes.error_autocompletar,{tipo:"alert-error"})}if(e.mensajes.no_cambios_autocompletar){kernel.ui.show_mensaje(e.mensajes.no_cambios_autocompletar,{tipo:"alert-info"})}$("#btnCompletar").on("click",function(w){w.preventDefault();t()});function t(){var x=$("#preset_campo").val();var C=[e.autocompletar_campo_nota_cursada,e.autocompletar_campo_nota_promocion,e.autocompletar_campo_resultado_cursada,e.autocompletar_campo_resultado_promocion,e.autocompletar_campo_fecha,e.autocompletar_campo_observaciones];if($.inArray(x,C)===-1){kernel.ui.show_mensaje(e.mensajes.completar_invalido,{tipo:"alert-error"});return false}var w=$("#autocompletar_para").val();var z=[e.autocompletar_para_todos_pagina,e.autocompletar_para_sin_datos_pagina,e.autocompletar_para_todos,e.autocompletar_para_sin_datos];if($.inArray(w,z)===-1){kernel.ui.show_mensaje(e.mensajes.para_invalido,{tipo:"alert-error"});return false}var B=$.trim($("#preset_form").find("#js-valor-"+x).val());if(B==""){kernel.ui.show_mensaje(e.mensajes.valor_vacio,{tipo:"alert-error"});return false}if(x===e.autocompletar_campo_nota_cursada&&!i().validar(B)){kernel.ui.show_mensaje(e.mensajes.nota_invalida,{tipo:"alert-error"});return false}if(x===e.autocompletar_campo_nota_promocion&&!d().validar(B)){kernel.ui.show_mensaje(e.mensajes.nota_invalida,{tipo:"alert-error"});return false}if(x===e.autocompletar_campo_fecha&&!m(B)){kernel.ui.show_mensaje(e.mensajes.fecha_invalida,{tipo:"alert-error"});return false}if($.inArray(x,[e.autocompletar_campo_resultado_cursada,e.autocompletar_campo_resultado_promocion])!==-1){var A=[];if(x===e.autocompletar_campo_resultado_cursada){A=e.resultados_regularidad}else{A=e.resultados_promocion}if($.inArray(B,A)===-1){kernel.ui.show_mensaje(e.mensajes.resultado_invalido,{tipo:"alert-error"});return false}}var y=[e.autocompletar_para_todos_pagina,e.autocompletar_para_sin_datos_pagina];if($.inArray(w,y)!==-1){q(x,B,w)}else{kernel.ui.prompt({msg:e.mensajes.msg_prompt_modificara_todas_paginas,msg_ok:e.mensajes.aceptar,msg_cancel:e.mensajes.cancelar,ok:function(){sessionStorage.hay_cambios=false;$("#preset_form").submit()}})}}function q(x,y,w){let selector_instancia="";let selector_campo="";let hubo_cambios=false;switch(x){case e.autocompletar_campo_nota_cursada:selector_instancia=".js-renglon-regular";selector_campo='[data-tipo="nota"]';break;case e.autocompletar_campo_nota_promocion:selector_instancia=".js-renglon-promocion";selector_campo='[data-tipo="nota"]';break;case e.autocompletar_campo_resultado_cursada:selector_instancia=".js-renglon-regular";selector_campo='[data-tipo="resultado"]';break;case e.autocompletar_campo_resultado_promocion:selector_instancia=".js-renglon-promocion";selector_campo='[data-tipo="resultado"]';break;case e.autocompletar_campo_fecha:selector_instancia=".js-renglon-regular, .js-renglon-promocion";selector_campo='[data-tipo="fecha"]';break;case e.autocompletar_campo_observaciones:selector_instancia=".js-renglon-regular, .js-renglon-promocion";selector_campo='[data-tipo="observacion"]';break}const z=(w===e.autocompletar_para_sin_datos_pagina);n();$("#btn_undo_autocompletar").prop("disabled",false);$(selector_instancia).each(function(){if($(this).find(selector_campo).length>0){if(z){if($(this).find(selector_campo).val()===""){if($(this).find(selector_campo).val()!==y){hubo_cambios=true}$(this).find(selector_campo).val(y).change().keyup()}}else{if($(this).find(selector_campo).val()!==y){hubo_cambios=true}$(this).find(selector_campo).val(y).change().keyup()}}});if(hubo_cambios){$("#notas_cursada_filtrar_acta").val("todas-todas").change();kernel.ui.show_mensaje(e.mensajes.msg_exito_autocompletar,{tipo:"alert-success"})}else{kernel.ui.show_mensaje(e.mensajes.msg_no_cambios_autocompletar,{tipo:"alert-info"})}}$("#btn_undo_autocompletar").on("click",function(w){w.preventDefault();p();$("#btn_undo_autocompletar").prop("disabled",true)});b=a(e.fecha_inicio);g=a(e.fecha_fin);$("#js-valor-"+e.autocompletar_campo_fecha).datepicker({minDate:b,maxDate:g});function m(x){var w=a(x);return(w.getTime()>=b.getTime()&&w.getTime()<=g.getTime())}$("#preset_campo").on("change",function(){$("#preset_form").find(".preset_valor:not(.resultado)").val("");var w=$(this).val();f(w);h()});$(".preset_valor").on("keyup",function(){h()});$("#preset_form .preset_valor").change(function(){h();var w=$("#preset_campo").val();var x;if(w===e.autocompletar_campo_nota_cursada){x=$.trim($("#preset_form").find("#js-valor-"+w).val());if(x===""){return false}if(!i().validar(x)){$("#preset_form").find("#js-valor-"+w).val("");kernel.ui.show_mensaje(e.mensajes.nota_invalida,{tipo:"alert-error"})}}if(w===e.autocompletar_campo_nota_promocion){x=$.trim($("#preset_form").find("#js-valor-"+w).val());if(x===""){return false}if(!d().validar(x)){$("#preset_form").find("#js-valor-"+w).val("");kernel.ui.show_mensaje(e.mensajes.nota_invalida,{tipo:"alert-error"})}}if(w===e.autocompletar_campo_fecha){x=$.trim($("#preset_form").find("#js-valor-"+w).val());if(x===""){return false}if(!m(x)){$("#preset_form").find("#js-valor-"+w).val("");kernel.ui.show_mensaje(e.mensajes.fecha_invalida,{tipo:"alert-error"})}}});var u=[];var v=[];function n(){u=[];v=[];$(".js-renglon-regular").each(function(){if($(this).find("[data-tipo='nota']").length>0){var x={fecha:$(this).find("[data-tipo='fecha']").val(),nota:$(this).find("[data-tipo='nota']").val(),resultado:$(this).find("[data-tipo='resultado']").val(),condicion:$(this).find("[data-tipo='cond_regularidad']").val(),observacion:$(this).find("[data-tipo='observacion']").val()};var w=$(this).data("renglon");u[w]=x}});$(".js-renglon-promocion").each(function(){if($(this).find("[data-tipo='nota']").length>0){var x={fecha:$(this).find("[data-tipo='fecha']").val(),nota:$(this).find("[data-tipo='nota']").val(),resultado:$(this).find("[data-tipo='resultado']").val(),observacion:$(this).find("[data-tipo='observacion']").val()};var w=$(this).data("renglon");v[w]=x}})}function p(){$(".js-renglon-regular").each(function(x){var w=$(this).data("renglon");var y=u[w];if(w){$(this).find("[data-tipo='fecha']").val(y.fecha).change().keyup();$(this).find("[data-tipo='nota']").val(y.nota).change().keyup();$(this).find("[data-tipo='resultado']").val(y.resultado).change().keyup();$(this).find("[data-tipo='cond_regularidad']").val(y.condicion).change().keyup();$(this).find("[data-tipo='observacion']").val(y.observacion).change().keyup()}});$(".js-renglon-promocion").each(function(x){var w=$(this).data("renglon");var y=v[w];if(w){$(this).find("[data-tipo='fecha']").val(y.fecha).change().keyup();$(this).find("[data-tipo='nota']").val(y.nota).change().keyup();$(this).find("[data-tipo='resultado']").val(y.resultado).change().keyup();$(this).find("[data-tipo='observacion']").val(y.observacion).change().keyup()}});u=[];v=[]}$("#btn_undo_nota").on("click",function(w){w.preventDefault();p();$("#btn_undo_nota").prop("disabled",true)});if(e.mensajes.exito_calcular_nota){kernel.ui.show_mensaje(e.mensajes.exito_calcular_nota,{tipo:"alert-success"})}if(e.mensajes.sin_alumnos_calcular_nota){kernel.ui.show_mensaje(e.mensajes.sin_alumnos_calcular_nota,{tipo:"alert-info"})}if(e.mensajes.error_calcular_nota){kernel.ui.show_mensaje(e.mensajes.error_calcular_nota,{tipo:"alert-error"})}if(e.mensajes.error_regla_calculo){$.facebox(e.mensajes.error_regla_calculo)}$("#btn_completar_nota").on("click",function(w){w.preventDefault();o()});function o(){var y=$("#instancia").val();var B=[e.inst_cursar,e.inst_promocionar];if($.inArray(y,B)===-1){kernel.ui.show_mensaje(e.mensajes.instancia_invalida,{tipo:"alert-error"});return false}var w=$("#aplicar_a").val();var A=[e.autocompletar_para_todos_pagina,e.autocompletar_para_sin_datos_pagina,e.autocompletar_para_todos,e.autocompletar_para_sin_datos];if($.inArray(w,A)===-1){kernel.ui.show_mensaje(e.mensajes.aplicar_a_invalido,{tipo:"alert-error"});return false}var x=$("#regla_calculo").val();if($.inArray(x,e.reglas_calculo)===-1){kernel.ui.show_mensaje(e.mensajes.regla_calculo_invalido,{tipo:"alert-error"});return false}var z=[e.autocompletar_para_todos_pagina,e.autocompletar_para_sin_datos_pagina];if($.inArray(w,z)!==-1){s(y,w,x)}else{kernel.ui.prompt({msg:e.mensajes.msg_prompt_modificara_todas_paginas,msg_ok:e.mensajes.aceptar,msg_cancel:e.mensajes.cancelar,ok:function(){sessionStorage.hay_cambios=false;$("#calcular-notas").submit()}})}}function s(z,x,y){var w=[];var B;n();$("#btn_undo_nota").prop("disabled",false);if(z===e.inst_cursar){B=$(".js-renglon-regular")}else{if(z===e.inst_promocionar){B=$(".js-renglon-promocion")}}var A=(x===e.autocompletar_para_sin_datos_pagina);B.each(function(){if($(this).find("[data-tipo='nota']").length>0){if(A){if($(this).find("[data-tipo='nota']").val()===""){w.push($(this).data("renglon"))}}else{w.push($(this).data("renglon"))}}});if(w.length==0){kernel.ui.show_mensaje(e.mensajes.msg_sin_alumnos_calcular_nota,{tipo:"alert-info"});return false}kernel.ajax.call(e.url_calcular_notas,{type:"POST",data:{instancia:z,regla_calculo:y,alumnos:w},success:function(E){if(E.cont.hubo_error){kernel.ui.show_mensaje(E.cont.msg_error,{tipo:"alert-error"});return false}var H=E.cont.notas;var D=false;var G="";if(Object.keys(H).length>0){B.each(function(){if(H[$(this).data("renglon")]<0){D=true;G=H[$(this).data("renglon")]}else{if(A){if($(this).find("[data-tipo='nota']").val()===""){$(this).find("[data-tipo='nota']").val(H[$(this).data("renglon")]).change().keyup()}}else{$(this).find("[data-tipo='nota']").val(H[$(this).data("renglon")]).change().keyup()}}})}if(D===true){var C="";var F="";switch(G){case"-1":F=e.mensajes.escalas_notas_deben_ser_numericas;break;case"-2":F=e.mensajes.no_hay_evaluaciones_promediables;break;case"-3":F=e.mensajes.escalas_notas_deben_ser_consistentes;break;case"-4":F=e.mensajes.no_hay_evaluaciones_comision;break;default:F=e.mensajes.error_desconocido}C=$("<div style='font-weight: bold; text-align: center;'>"+e.mensajes.no_pueden_calcular_notas+"</div><br /><div>"+F+"</div>");$.facebox(C)}else{$("#notas_cursada_filtrar_acta").val("todas-todas").change();kernel.ui.show_mensaje(e.mensajes.msg_exito_calcular_nota,{tipo:"alert-success"})}}})}const r=setTimeout(j,5000);k();l()}}});